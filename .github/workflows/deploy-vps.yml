name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ“‹ Copy deploy script to VPS
        run: |
          scp -P ${{ secrets.VPS_PORT }} \
            .github/scripts/deploy.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/deploy.sh
      
      - name: ðŸš€ Execute deployment
        id: deploy
        run: |
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            export VPS_APP_PATH="${{ secrets.VPS_APP_PATH }}"
            export VPS_DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
            export VPS_FILE_OWNER="${{ secrets.VPS_FILE_OWNER }}"
            
            chmod +x /tmp/deploy.sh
            /tmp/deploy.sh
          ENDSSH
      
      - name: ðŸ¥ Health check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" https://convertidordivisas.com/ || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… Health check passed (HTTP $response)"
          else
            echo "âŒ Health check failed (HTTP $response)"
            exit 1
          fi
      
      - name: ðŸ”„ Rollback on failure
        if: failure()
        run: |
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            BACKUP_DIR="/home/backup-deploys"
            LATEST_BACKUP=$(ls -t $BACKUP_DIR | head -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ðŸ”„ Rolling back to: $LATEST_BACKUP"
              cp -a $BACKUP_DIR/$LATEST_BACKUP/* ${{ secrets.VPS_DEPLOY_PATH }}/
              chown -R ${{ secrets.VPS_FILE_OWNER }} ${{ secrets.VPS_DEPLOY_PATH }}/
              systemctl restart lsws
              echo "âœ… Rollback completed"
            else
              echo "âš ï¸  No backup found for rollback"
            fi
          ENDSSH
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "rm -f /tmp/deploy.sh" || true
          rm -f ~/.ssh/id_ed25519
